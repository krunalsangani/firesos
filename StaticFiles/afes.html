<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Drone Dashboard</title>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Ahmedabad Fire and Emergency Services</title>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap"
              rel="stylesheet" />
        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="css/dashboard.css" />
        <script type="text/javascript" src="js/constants.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    </head>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            color: #333;
            background-color: #f5f5f5;
        }

        h1, h2 {
            margin: 0 0 10px;
        }

        .panel {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .top-info {
            display: grid;
            grid-template-columns: 1fr 1fr; /* two halves */
            gap: 20px;
            margin-bottom: 20px;
        }

        .icon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .icon-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

            .icon-item img {
                width: 32px;
                height: 32px;
            }

        .map-container {
            height: 600px; /* adjust depending on your map embed */
            border: 1px solid #ccc;
            border-radius: 6px;
            overflow: hidden;
        }

        .media-feed {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        /* Stretch the map for larger screens */
        @media (min-width: 1600px) {
            .map-container {
                height: 700px;
            }
        }

        @media (max-width: 1024px) {
            .top-info {
                grid-template-columns: 1fr; /* collapse to single column */
            }
        }

        .map2 {
            height: 520px !important;
            width: 100% !important;
        }

        .dashboard-heading {
            display: flex;
            align-items: center;
            gap: 12px; /* spacing between logo and text */
            font-size: 32px;
            margin: 0;
        }

        .dashboard-heading {
            display: flex;
            align-items: center;
            gap: 12px; /* spacing between logo and text */
            font-size: 24px;
            margin: 0;
        }

        .police-logo {
            height: 120px;
            width: auto;
            object-fit: contain;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Top Info Section -->
    <div class="top-info">
        <div class="panel">
            <div style="float:left">
                <img style="padding:10px" src="/StaticFiles/images/logo.png"
                     alt="Police Logo"
                     class="police-logo" />
            </div>
            <div style="float:left;margin-left:160px">
                <h1>
                    Ahmedabad Fire Monitoring Dashboard
                </h1>
                <h2>Fire Station Address</h2>
                <p class="drone-station-address"></p>
                <p><strong>Response Time:</strong><span class="drone-response-time">12.5 mins</span></p>
            </div>
        </div>

        <div class="panel">
            <h2>User Profile</h2>
            <p><strong>Name:</strong><span class="info-value requestor-name"> Rajesh Kumar</span></p>
            <p><strong>Emergency Type:</strong><span class="info-value requestor-emergency-type"> Fire</span></p>
            <p><strong>Phone:</strong><span class="info-value requestor-phone"> 99135 47448</span></p>
            <p><strong>Address:</strong><span class="info-value requestor-address"> Ahmedabad</span></p>



            <div class="icon-grid">
                <div class="icon-item"><img src="/StaticFiles/images/fire_truck.png" alt="Drone"> Fire Truck</div>
                <div class="icon-item"><img src="/Staticfiles/images/drone_red.png" alt="Fire Station"> Fire Station</div>
                <div class="icon-item"><img src="/StaticFiles/images/requestor.png" alt="Ambulance"> Incident</div>
            </div>
        </div>
    </div>

    <!-- Map Full Width -->
    <div class="panel map-container map2" id="map">
        <!-- Replace with your map iframe or JS embed -->

    </div>

    <!-- Media Feeds -->
    <div class="panel">
        <h2>Drone Footage</h2>
        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/aea1afe5605c9d204bb4f13de7cbdc16e51c16cd" class="media-feed" alt="Drone Feed">
    </div>

    <div class="panel">
        <h2>CCTV Feed</h2>
        <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/766a514d366f0fdce6a05aacf6548d690b267b10" class="media-feed" alt="CCTV Feed">
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlpCd4M34Hfxc-VRLXwUUZ6-pKFnKZA14&v=weekly&libraries=marker"
            defer></script>

    <script type="text/javascript">
        let map;
        let markers = new Map();
        let droneMarkers = new Map();
        let patrolMarkers = new Map();


        function populateDronePanel(item) {
            var droneNumber = item.droneNumber;
            var droneAddress = item.stationAddress;

            var timeInMinutes = item.timeInMinutes;
            var distanceInKm = item.distanceInKm;

            $(".drone-number").text(droneNumber);
            $(".drone-station-address").text(droneAddress);
            $(".drone-response-time").text(timeInMinutes.toFixed(2) + " minutes");
        }

        function populateEmergencyType(item) {
            var emergencyType = item.emergencyTypeName;
            $(".requestor-emergency-type").text(emergencyType);


        }

        function populateRequestSidePanel(item) {
            var name = item.name;
            var phone = item.phoneNumber;
            var address = item.address;

            var emergencyPhone = item.emergencyContactPhoneNumber;
            var emergencyRel = item.emergencyContactRelationship;

            $(".requestor-name").text(name);
            $(".requestor-phone").text(phone);
            $(".requestor-address").text(address);

            $(".requestor-emergency-phone").text(emergencyPhone);
            $(".requestor-emergency-rel").text(emergencyRel);
        }

        function populateLeftSidePanel(item) {
            var patrolType = item.patrol.patrolType.patrolTypeName;
            var patrolNumber = item.patrol.patrolNumber;
            var patrolCallSign = item.patrol.patrolCallSign;
            var patrolingNotes = item.patrol.patrollingNotes;
            var timeInMinutes = item.timeInMinutes;
            var distanceInKm = item.distanceInKm;
            console.log(patrolType);
            if (patrolType == "PCR") {
                $(".pcr-number").text(patrolNumber);
                $(".pcr-callsign").text(patrolCallSign);
                $(".pcr-response-time").text(timeInMinutes.toFixed(2) + " minutes");
            }
            else if (patrolType == "Motorbike") {
                $(".motorbike-number").text(patrolNumber);
                $(".motorbike-call-sign").text(patrolCallSign);
                $(".motorbike-response-time").text(timeInMinutes.toFixed(2) + " minutes");
            }
            else if (patrolType == "Foot Soldier") {
                $(".foot-patrol-response-time").text(timeInMinutes.toFixed(2) + " minutes");
                $(".foot-patrol-name").text(patrolNumber);
            }
        }

        function loadDrones(lat, lng, map) {
            //Load Drone stations
            var dataUrl = serverURL + '/api/drone?requestorLatitude=' + lat + '&requestorLongitude=' + lng;
            var _locations = [];
            var populate = true;
            // Fetch data from the URL
            $.getJSON(dataUrl, function (data) {
                $.each(data, function (index, item) {
                    var droneStationImg = document.createElement("img");
                    droneStationImg.src = "/StaticFiles/images/fire_station.png";
                    if (populate) {
                        populateDronePanel(item);
                        populate = false;
                    }

                    if (droneMarkers.has(item.id)) {
                        var marker = droneMarkers.get(item.id);
                        marker.position = new google.maps.LatLng(item.latitude, item.longitude);
                    }
                    else {
                        const droneMarkerView = new google.maps.marker.AdvancedMarkerElement({
                            map,
                            position: { lat: item.latitude, lng: item.longitude },
                            content: droneStationImg,
                            title: "Drone Number: " + item.droneNumber + '\nDeployed Location: ' + item.droneName + '\nAddress: ' + item.stationAddress,
                            gmpClickable: true,
                        });
                        droneMarkers.set(item.id, droneMarkerView);
                    }
                });
            });
        }

        function populateRoute(patrolLatitude, patrolLongitude, reqLat, reqLong, map, mode) {
            const directionService = new google.maps.DirectionsService();
            let strokeColor;
            if (mode == 1) {
                strokeColor = "red";
            }
            else if (mode == 2) {
                strokeColor = "blue";
            }
            else if (mode == 3) {
                strokeColor = "red";
            }
            const directionRenderer = new google.maps.DirectionsRenderer({ map: map, polylineOptions: { strokeColor: strokeColor }, suppressMarkers: true });
            calculateAndDisplayRoute(directionService, directionRenderer, { lat: patrolLatitude, lng: patrolLongitude }, { lat: reqLat, lng: reqLong }, 1);

        }

        function calculateAndDisplayRoute(directionsService, directionsRenderer, start, end, mode) {
            let travelMode = google.maps.TravelMode.DRIVING;

            if (mode == 2) {
                travelMode = google.maps.TravelMode.DRIVING;        //Two wheeler available only in computeRoutes v2
            }
            if (mode == 3) {
                travelMode = google.maps.TravelMode.WALKING;
            }
            directionsService.route(
                {
                    origin: start,
                    destination: end,
                    travelMode: travelMode,
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                }
            );
        }

        function loadPatrols(lat, lng, map) {
            //Load Patrolling officers
            dataUrl = serverURL + '/api/PatrolLocations?requestorLatitude=' + lat + '&requestorLongitude=' + lng;
            _locations = [];

            // Fetch data from the URL
            $.getJSON(dataUrl, function (data) {
                var patrolTypeName = '';
                console.log(data.length);
                $.each(data, function (index, item) {
                    var patrolTypeImg = document.createElement("img");
                    //only populate the first item of each patrol type
                    if (patrolTypeName != item.patrol.patrolType.patrolTypeName) {
                        populateLeftSidePanel(item);
                        console.log("---" + item.patrol.patrolTypeId);
                        populateRoute(item.latitude, item.longitude, lat, lng, map, item.patrol.patrolTypeId);
                    }

                    patrolTypeName = item.patrol.patrolType.patrolTypeName;
                    patrolTypeImg.src = "/StaticFiles/images/" + item.patrol.patrolType.patrolTypeName + "_fire.png";

                    if (patrolMarkers.has(item.patrolId)) {
                        var marker = patrolMarkers.get(item.patrolId);
                        marker.position = new google.maps.LatLng(item.latitude, item.longitude);
                    }
                    else {

                        const droneMarkerView = new google.maps.marker.AdvancedMarkerElement({
                            map,
                            position: { lat: item.latitude, lng: item.longitude },
                            content: patrolTypeImg,
                            title: "Time to reach: " + item.timeInMinutes.toFixed(2) + " minutes. (" + item.distanceInKm.toFixed(2) + " kms) \nName: " + item.patrol.patrolNumber + "\nCall Sign: " + item.patrol.patrolCallSign + "\nPatrol Type: " + item.patrol.patrolType.patrolTypeName + '\n' + item.patrol.patrollingNotes,
                            gmpClickable: true,
                        });
                        patrolMarkers.set(item.patrolId, droneMarkerView);
                    }
                });
            });
        }

        function loadRequestor(id, map) {
            //Load Requestor information
            var rdataUrl = serverURL + '/api/remoteLocation/' + id;

            $.getJSON(rdataUrl, function (data) {
                var requestorImage = document.createElement("img");
                requestorImage.src = "/StaticFiles/images/requestor.png";

                populateRequestSidePanel(data.userProfile);
                populateEmergencyType(data.emergencyType);

                lat = data.latitude;
                lng = data.longitude;


                if (markers.has(data.id)) {
                    var marker = markers.get(data.id);
                    marker.position = new google.maps.LatLng(data.latitude, data.longitude);
                }
                else {
                    const requestorMarkerView = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position: { lat: data.latitude, lng: data.longitude },
                        content: requestorImage,
                        title: "Name: " + data.userProfile.name + '\nPhone: ' + data.userProfile.phoneNumber + '\n',
                        gmpClickable: true,
                    });
                    markers.set(data.id, requestorMarkerView);

                }

                loadDrones(lat, lng, map);
                loadPatrols(lat, lng, map);

                setTimeout(loadRequestor, 15000, id, map);
            });
        }

        $(document).ready(function () {
            const position = { lat: 23.025, lng: 72.554 };


            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: position,
                mapId: "DEMO_MAP_ID", // Map ID is required for advanced markers.
            });

            var urlParams = new URLSearchParams(window.location.search);
            var lat = 0.0;
            var lng = 0.0;

            if (urlParams.has('id')) {
                var id = urlParams.get("id");
                loadRequestor(id, map);
            }
        });
    </script>
</body>
</html>
