<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Police Drone Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/dashboard.css" />
    <script type="text/javascript" src="js/constants.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
    <main class="dashboard-container">
        <header class="header">
            <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/b4199aa9f272b8da1869cae21256a8bb81132b03"
                 alt="Police Logo"
                 class="police-logo" />
            <center>
                <h1>Gujarat Police Monitoring Dashboard</h1>
            </center>
        </header>

        <section class="station-info">
            <h2 class="section-heading">Drone Station Address</h2>
            <address class="drone-station-address">
                Doctor House, India Colony, Main Road, Bapunagar, Tolnaka, India
                Colony, Ahmedabad, Gujarat 382350, India
            </address>

            <div class="info-section drone-info">
                <div class="info-row">
                    <span class="info-label">Drone Number -</span>
                    <span class="info-value drone-number"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Drone Response Time -</span>
                    <span class="info-value drone-response-time">2 minutes</span>
                </div>
            </div>

            <div class="info-section pcr-info">
                <div class="info-row">
                    <span class="info-label">PCR Number -</span>
                    <span class="info-value pcr-number">N.A.</span>
                </div>
                <div class="info-row">
                    <span class="info-label">PCR Callsign -</span>
                    <span class="info-value pcr-callsign">*N.A*</span>
                </div>
                <div class="info-row">
                    <span class="info-label">PCR Response Time -</span>
                    <span class="info-value pcr-response-time">N.A.</span>
                </div>
            </div>

            <div class="info-section motorbike-info">
                <div class="info-row">
                    <span class="info-label">Motorbike -</span>
                    <span class="info-value motorbike-number">N.A.</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Motorbike Callsign -</span>
                    <span class="info-value motorbike-call-sign">*Name*</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Motorbike Response Time -</span>
                    <span class="info-value motorbike-response-time">N.A.</span>
                </div>
            </div>

            <div class="info-section patrol-info">
                <div class="info-row">
                    <span class="info-label">Foot Patrol -</span>
                    <span class="info-value foot-patrol-name">N.A.</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Foot Patrol Response Time -</span>
                    <span class="info-value foot-patrol-response-time">N.A.</span>
                </div>
            </div>
        </section>

        <section class="map-section map">
            <div id="map" class="map"></div>
        </section>

        <aside class="user-profile">
            <h2 class="profile-heading">User Profile</h2>
            <div class="profile-info">
                <div class="info-row">
                    <span class="info-label">Name -</span>
                    <span class="info-value requestor-name">Name</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone -</span>
                    <span class="info-value requestor-phone"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Address -</span>
                    <span class="info-value requestor-address">
                    </span>
                </div>
            </div>

            <div class="emergency-contact">
                <h3 class="emergency-heading">Emergency Contact Information</h3>
                <div class="info-row">
                    <span class="info-label ">Phone -</span>
                    <span class="info-value requestor-emergency-phone"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Status -</span>
                    <span class="info-value requestor-emergency-rel"></span>
                </div>
            </div>

            <div class="map-legend">
                <div class="legend-item">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/8289aaaec3bdb21e50bfd18ce07564e8913ea427"
                         alt="Drone icon"
                         class="legend-icon" />
                    <span>- Drone</span>
                </div>
                <div class="legend-item">
                    <img src="images/drone_red.png"
                         alt="Drone Station icon"
                         class="legend-icon" />
                    <span>- Drone Station</span>
                </div>
                <div class="legend-item">
                    <img src="/StaticFiles/images/requestor.png"
                         alt="Crime icon"
                         class="legend-icon" />
                    <span>- Crime</span>
                </div>
                <div class="legend-item">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/75da33be1fef1b4247d176faa3e593ab6616a777"
                         alt="PCR icon"
                         class="legend-icon" />
                    <span>- PCR</span>
                </div>
                <div class="legend-item">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/219db24620d1f23330696481133c73d86336d16d"
                         alt="Motorbike icon"
                         class="legend-icon" />
                    <span>- Motorbike</span>
                </div>
                <div class="legend-item">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/4934aa0c6aff796e5c3f2aaa50ebce9ed6702bec"
                         alt="Foot Patrol icon"
                         class="legend-icon" />
                    <span>- Foot Patrol</span>
                </div>
            </div>
        </aside>

        <section class="footage-section">
            <article class="footage-container">
                <h3 class="footage-title">Drone Footage</h3>
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/aea1afe5605c9d204bb4f13de7cbdc16e51c16cd"
                     alt="Drone footage"
                     class="footage-feed" />
            </article>
            <article class="footage-container">
                <h3 class="footage-title">CCTV Feed</h3>
                <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/766a514d366f0fdce6a05aacf6548d690b267b10"
                     alt="CCTV feed"
                     class="footage-feed" />
            </article>
        </section>

    </main>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlpCd4M34Hfxc-VRLXwUUZ6-pKFnKZA14&v=weekly&libraries=marker"
            defer></script>

    <script type="text/javascript">
        let map;
        let markers = new Map();
        let droneMarkers = new Map();
        let patrolMarkers = new Map();


        function populateDronePanel(item) {
            var droneNumber = item.droneNumber;
            var droneAddress = item.stationAddress;

            var timeInMinutes = item.timeInMinutes;
            var distanceInKm = item.distanceInKm;

            $(".drone-number").text(droneNumber);
            $(".drone-station-address").text(droneAddress);
            $(".drone-response-time").text(timeInMinutes.toFixed(2) + " minutes");
        }

        function populateRequestSidePanel(item) {
            var name = item.name;
            var phone = item.phoneNumber;
            var address = item.address;

            var emergencyPhone = item.emergencyContactPhoneNumber;
            var emergencyRel = item.emergencyContactRelationship;

            $(".requestor-name").text(name);
            $(".requestor-phone").text(phone);
            $(".requestor-address").text(address);

            $(".requestor-emergency-phone").text(emergencyPhone);
            $(".requestor-emergency-rel").text(emergencyRel);
        }

        function populateLeftSidePanel(item) {
            var patrolType = item.patrol.patrolType.patrolTypeName;
            var patrolNumber = item.patrol.patrolNumber;
            var patrolCallSign = item.patrol.patrolCallSign;
            var patrolingNotes = item.patrol.patrollingNotes;
            var timeInMinutes = item.timeInMinutes;
            var distanceInKm = item.distanceInKm;
            console.log(patrolType);
            if (patrolType == "PCR") {
                $(".pcr-number").text(patrolNumber);
                $(".pcr-callsign").text(patrolCallSign);
                $(".pcr-response-time").text(timeInMinutes.toFixed(2) + " minutes");
            }
            else if (patrolType == "Motorbike") {
                $(".motorbike-number").text(patrolNumber);
                $(".motorbike-call-sign").text(patrolCallSign);
                $(".motorbike-response-time").text(timeInMinutes.toFixed(2) + " minutes");
            }
            else if (patrolType == "Foot Soldier") {
                $(".foot-patrol-response-time").text(timeInMinutes.toFixed(2) + " minutes");
                $(".foot-patrol-name").text(patrolNumber);
            }
        }

        function loadDrones(lat,lng,map) {
            //Load Drone stations
            var dataUrl = serverURL + '/api/drone?requestorLatitude=' + lat + '&requestorLongitude=' + lng;
            var _locations = [];
            var populate = true;
            // Fetch data from the URL
            $.getJSON(dataUrl, function (data) {
                $.each(data, function (index, item) {
                    var droneStationImg = document.createElement("img");
                    droneStationImg.src = "/StaticFiles/images/drone_red.png";
                    if (populate) {
                        populateDronePanel(item);
                        populate = false;
                    }

                    if (droneMarkers.has(item.id)) {
                        var marker = droneMarkers.get(item.id);
                        marker.position = new google.maps.LatLng(item.latitude, item.longitude);
                    }
                    else {
                        const droneMarkerView = new google.maps.marker.AdvancedMarkerElement({
                            map,
                            position: { lat: item.latitude, lng: item.longitude },
                            content: droneStationImg,
                            title: "Drone Number: " + item.droneNumber + '\nDeployed Location: ' + item.droneName + '\nAddress: ' + item.stationAddress,
                            gmpClickable: true,
                        });
                        droneMarkers.set(item.id, droneMarkerView);
                    }
                });
            });
        }

        function populateRoute(patrolLatitude,patrolLongitude,reqLat,reqLong,map,mode) {
            const directionService = new google.maps.DirectionsService();
            let strokeColor;
            if (mode == 1) {
                strokeColor = "green";
            }
            else if (mode == 2) {
                strokeColor = "blue";
            }
            else if (mode == 3) {
                strokeColor = "red";
            }
            const directionRenderer = new google.maps.DirectionsRenderer({ map: map, polylineOptions: { strokeColor: strokeColor }, suppressMarkers: true });
            calculateAndDisplayRoute(directionService, directionRenderer, { lat: patrolLatitude, lng: patrolLongitude },{ lat: reqLat, lng: reqLong },1 );

        }

        function calculateAndDisplayRoute(directionsService, directionsRenderer, start, end,mode) {
            let travelMode = google.maps.TravelMode.DRIVING;

            if (mode == 2) {
                travelMode = google.maps.TravelMode.DRIVING;        //Two wheeler available only in computeRoutes v2
            }
            if (mode == 3) {
                travelMode = google.maps.TravelMode.WALKING;
            }
            directionsService.route(
                {
                    origin: start,
                    destination: end,
                    travelMode: travelMode,
                },
                (response, status) => {
                    if (status === "OK") {
                        directionsRenderer.setDirections(response);
                    } else {
                        console.error("Directions request failed due to " + status);
                    }
                }
            );
        }

        function loadPatrols(lat,lng,map) {
            //Load Patrolling officers
            dataUrl = serverURL + '/api/PatrolLocations?requestorLatitude=' + lat + '&requestorLongitude=' + lng;
            _locations = [];

            // Fetch data from the URL
            $.getJSON(dataUrl, function (data) {
                var patrolTypeName = '';
                console.log(data.length);
                $.each(data, function (index, item) {
                    var patrolTypeImg = document.createElement("img");
                    //only populate the first item of each patrol type
                    if (patrolTypeName != item.patrol.patrolType.patrolTypeName) {
                        populateLeftSidePanel(item);
                        console.log("---" + item.patrol.patrolTypeId);
                        populateRoute(item.latitude,item.longitude,lat,lng,map,item.patrol.patrolTypeId);
                    }
                    
                    patrolTypeName = item.patrol.patrolType.patrolTypeName;
                    patrolTypeImg.src = "/StaticFiles/images/" + item.patrol.patrolType.patrolTypeName + ".png";

                    if (patrolMarkers.has(item.patrolId)) {
                        var marker = patrolMarkers.get(item.patrolId);
                        marker.position = new google.maps.LatLng(item.latitude, item.longitude);
                    }
                    else {

                        const droneMarkerView = new google.maps.marker.AdvancedMarkerElement({
                            map,
                            position: { lat: item.latitude, lng: item.longitude },
                            content: patrolTypeImg,
                            title: "Time to reach: " + item.timeInMinutes.toFixed(2) + " minutes. (" + item.distanceInKm.toFixed(2) + " kms) \nName: " + item.patrol.patrolNumber + "\nCall Sign: " + item.patrol.patrolCallSign + "\nPatrol Type: " + item.patrol.patrolType.patrolTypeName + '\n' + item.patrol.patrollingNotes,
                            gmpClickable: true,
                        });
                        patrolMarkers.set(item.patrolId, droneMarkerView);
                    }
                });
            });
        }

        function loadRequestor(id,map) {
            //Load Requestor information
            var rdataUrl = serverURL + '/api/remoteLocation/' + id;

            $.getJSON(rdataUrl, function (data) {
                var requestorImage = document.createElement("img");
                requestorImage.src = "/StaticFiles/images/requestor.png";
                populateRequestSidePanel(data.userProfile);
                lat = data.latitude;
                lng = data.longitude;

                if (markers.has(data.id)) {
                    var marker = markers.get(data.id);
                    marker.position = new google.maps.LatLng(data.latitude, data.longitude);
                }
                else {
                    const requestorMarkerView = new google.maps.marker.AdvancedMarkerElement({
                        map,
                        position: { lat: data.latitude, lng: data.longitude },
                        content: requestorImage,
                        title: "Name: " + data.userProfile.name + '\nPhone: ' + data.userProfile.phoneNumber + '\n',
                        gmpClickable: true,
                    });
                    markers.set(data.id, requestorMarkerView);

                }

                loadDrones(lat, lng, map);
                loadPatrols(lat, lng, map);

                setTimeout(loadRequestor,15000,id,map);
            });
        }

        $(document).ready(function () {
            const position = { lat: 23.025, lng: 72.554 };


            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: position,
                mapId: "DEMO_MAP_ID", // Map ID is required for advanced markers.
            });

            var urlParams = new URLSearchParams(window.location.search);
            var lat = 0.0;
            var lng = 0.0;

            if (urlParams.has('id')) {
                var id = urlParams.get("id");
                loadRequestor(id,map); 
            }
        });
    </script>
</body>
</html>
